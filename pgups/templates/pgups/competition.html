{% extends 'pgups/base.html' %}
{% load staticfiles %}
{% load extras %}
{% block content %}

<div class="container" ng-app="competitionApp" ng-controller="CompetitionController as comp">

  <!-- HEADING -->
  <div class="heading">
    <h1><b>{{competition.name}}</b></h2>
  </div>

  {% if not competition.finished %}

    <div class="row">

      <div class="col-sm-8 dfk-tabs-content">

        {% if user.is_authenticated %}

        <ul class="nav nav-tabs">
          <li class="active"><a data-toggle="tab" href="#requests">Заявки</a></li>
            {% if request.user|has_group:"moderators" %}
          <li><a data-toggle="tab" href="#teams">Составы команд</a></li>
          <li><a data-toggle="tab" href="#tours">Дисциплины</a></li>
          <li><a data-toggle="tab" href="#relays">Эстафеты</a></li>
            {% endif %}
        </ul>

        {% endif %}

        <div class="tab-content ">

        {% if user.is_authenticated %}

          <!-- REQUESTS -->
          <div id="requests" class="tab-pane fade in active">


        <table class="table table-striped table-hover table-bordered">
          <thead>

            <tr>
              <th class="text-center">Дата</th>
              <th class="text-center">Команда</th>
              <th class="text-center">Тренер</th>
              {% if user.is_authenticated %}
                <th class="text-center">Подтверждено</th>
              {% endif %}
            </tr>
          </thead>

          <tbody>
            {% for userrequest in competition.userrequest_set.all %}

            {% if  request.user|has_group:"moderators" or request.user == userrequest.user  %}

              <tr >
                <td class="text-center"><a href="../../userrequest/{{userrequest.id}}/">{{userrequest.date|date:"d.m.Y"}}</a></td>
                {% if userrequest.team %}
                  <td class="text-center">{{userrequest.team}}</td>
                {% else %}
                  <td class="text-center">индивидуальная заявка</td>
                {% endif %}
                  <td class="text-center">{{userrequest.representative}}</td>
                {% if user.is_authenticated %}
                  <td class="text-center">{{userrequest.approved_competitors|length}} из {{userrequest.competitor_set.all|length}}</td>
                {% endif %}
              </tr>

            {% endif %}


            {% endfor %}
          </tbody>

          </table>

          </div>

            {% if request.user|has_group:"moderators" %}

          <!-- TEAMS -->
          <div id="teams" class="tab-pane fade">
            <ul class="basic-list">
              {% for team in teams %}
                <li>
                  <a href="../../competition/team/{{competition.id}}/{{team.id}}/">{{team}}</a>
                </li>
              {% endfor %}
                <li>
                  <a href="../../competition/team/{{competition.id}}/0/">Без команды</a>
                </li>
            </ul>
          </div>

          <!-- TOURS -->
          <div id="tours" class="tab-pane fade">
            <ul class="basic-list">
              {% for tour in competition.tour_set.all %}
              <!-- {% if tour.competitor_set.all|length > 0 %} -->
                <li>
                  <a href="../../tour/{{tour.id}}/">{{tour}}</a>
                </li>
              <!-- {% endif %} -->
              {% endfor %}
            </ul>
          </div>

          <!-- RELAYS -->
          <div id="relays" class="tab-pane fade">
            <ul class="basic-list">
              {% for relay in relays %}
                <li>
                  <a href="../../relay_teams/{{relay.id}}/">{{relay}}</a>
                </li>
              {% endfor %}
            </ul>
          </div>

            {% endif %}

          {% endif %}

        </div>

      </div>

    {% if user.is_authenticated and request.user|has_group:"moderators"%}
      <div class="col-sm-4">

        <ul class="nav nav-pills nav-stacked">

          <li class="nav-item">
            <a href="../../competition/starts/{{competition.id}}/">
               <span>Сетка заплывов</span>
               <span class="pull-right glyphicon glyphicon-list-alt"></span>
            </a>
          </li>

      {% endif %}

          <li class="nav-item">
            <a href="{% url 'starts_print' competition_id=competition.id %}" target="_blank">
              <span>Стартовые протоколы</span>
              <span class="pull-right glyphicon glyphicon-print"></span>
            </a>
          </li>

            {% if user.is_authenticated and request.user|has_group:"moderators"%}

          <li class="nav-item">
            <a href="#" ng-click="comp.openModal();">
              <span>Перегенерировать заплывы</span>
              <span class="glyphicon glyphicon-refresh pull-right"></span>
            </a>
          </li>

          <li class="nav-item bordered-item">
            <a href="../../competition_starts_sort/{{competition.id}}/">
              <span>Настройка заплывов</span>
              <span class="pull-right glyphicon glyphicon-wrench"></span>
            </a>
          </li>

          <li role="separator" class="divider"></li>

          <li class="nav-item">
            <a href="../../competition/relay_starts/{{competition.id}}/">
               <span>Сетка эстафет</span>
               <span class="pull-right glyphicon glyphicon-list-alt"></span>
            </a>
          </li>

          <li class="nav-item">
            <a href="../../competition_relays_sort/{{competition.id}}/">
              <span>Настройка эстафет</span>
              <span class="glyphicon glyphicon-wrench pull-right"></span>
            </a>
          </li>

          <li class="nav-item bordered-item">
            <a href="#" ng-click="comp.openModalRelay();">
              <span>Перегенерировать эстафетные заплывы</span>
              <span class="glyphicon glyphicon-refresh pull-right"></span>
            </a>
          </li>


            <li role="separator" class="divider"></li>

          <li class="nav-item">
            <a href="{% url 'competitionedit' competition_id=competition.id %}/" target="_blank">
              <span>Редактировать соревнования</span>
              <span class="pull-right glyphicon glyphicon-cog"></span>
            </a>
          </li>



          <li class="nav-item">
            <form action="." method="POST" >{% csrf_token %}
              <input type="hidden" name="competition_id" value="{{competition.id}}">
              <input type="hidden" name="close" value="1">
              <button type="submit" class="btn btn-link dfk-btn-link">
                 <span>Закрыть соревнования</span>
                 <span class="glyphicon glyphicon-off pull-right"></span>
              </button>
            </form>
          </li>

        </ul>

      </div>

    </div>

    <!-- MODAL TEMPLATE -->
    <script type="text/ng-template" id="modal.html">
      <div class="modal-content">

        <div class="modal-header text-center">
          <i><span class="text-danger">Внимание!</span> Текущие результаты заплывов будут удалены и сетка будет сгенерирована заново.</i>
        </div>

        <div class="modal-body">
          <form action="../../generate_starts/" method="POST" class="inline-form" ng-submit="$ctrl.cancel()">{% csrf_token %}
              <input type="hidden" name="competition_id" value="{{competition.id}}">

              <div class="row fields">
                <div class="col-sm-6">
                  <select name="lanes" class="lanes-select">
                    <option value="5">5 дорожек</option>
                    <option value="6">6 дорожек</option>
                  </select>
                </div>
                <div class="col-sm-6">
                  <input type="checkbox" name="ages" id="ages">
                    <label for="ages">С разбивкой по возрастам</label>
                </div>
              </div>

              <div class="modal-footer">
                <div class="btns-wrapper">
                  <button type="submit" class="btn btn-default">Перегенерировать</button>
                  <button type="button" ng-click="$ctrl.cancel()" class="btn btn-default">Отмена</button>
                </div>
              </div>
          </form>
        </div>

      </div>
    </script>

    <!-- RELAY MODAL TEMPLATE -->
    <script type="text/ng-template" id="modalRelay.html">
      <div class="modal-content">

        <div class="modal-header text-center">
          <i><span class="text-danger">Внимание!</span> Текущие результаты эстафет будут удалены и сетка будет
              сгенерирована заново.</i>
        </div>

        <div class="modal-body">
          <form action="../../generate_relay_starts/" method="POST" class="inline-form" ng-submit="$ctrl.cancel()">{% csrf_token %}
              <input type="hidden" name="competition_id" value="{{competition.id}}">

              <div class="row fields">
                <div class="col-sm-6">
                  <select name="lanes" class="lanes-select">
                    <option value="5">5 дорожек</option>
                    <option value="6">6 дорожек</option>
                  </select>
                </div>
                <!-- <div class="col-sm-6">
                  <input type="checkbox" name="ages" id="ages">
                    <label for="ages">С разбивкой по возрастам</label>
                </div> -->
              </div>

              <div class="modal-footer">
                <div class="btns-wrapper">
                  <button type="submit" class="btn btn-default">Перегенерировать</button>
                  <button type="button" ng-click="$ctrl.cancel()" class="btn btn-default">Отмена</button>
                </div>
              </div>
          </form>
        </div>

      </div>
    </script>

    {% endif %}

  {% else %}

  <div class="competition-menu">

    <p>
      <a class="btn btn-lg btn-primary" href="../../results/starts/{{competition.id}}/"><span class="glyphicon glyphicon-list-alt"></span> Результаты по заплывам и дорожкам</a>
    </p>

    <p>
      <a class="btn btn-lg btn-primary" href="../../results/tours/{{competition.id}}/"><span class="glyphicon glyphicon-list-alt"></span> Результаты по дисциплинам</a>
    </p>

    <p>
      <a class="btn btn-lg btn-primary" href="../../results/teams/{{competition.id}}/"><span class="glyphicon glyphicon-list-alt"></span> Результаты по командам</a>
    </p>

    <p>
      <a class="btn btn-lg btn-primary" href="{% url 'final_print' competition_id=competition.id %}" target="_blank"> <span class="glyphicon glyphicon-print"></span> Итоговые протоколы</a>
    </p>

    {% if user.is_authenticated and request.user|has_group:"moderators" %}
        <form action="." method="POST" >{% csrf_token %}
          <input type="hidden" name="competition_id" value="{{competition.id}}">
          <input type="hidden" name="close" value="0">
          <button type="submit" class="close-competition btn btn-lg btn-default">
            <span class="glyphicon glyphicon-wrench"></span> Редактировать результаты соревнований
          </button>
        </form>
    {% endif %}

  </div>

  {% endif %}

</div>

{% endblock %}

{% block additionaljs %}
  <link href="{% static 'libs/css/bootstrap-select.min.css' %}" rel="stylesheet"> <!-- Custom select styles -->
  <script src="{% static 'libs/js/bootstrap-select.min.js' %}"></script> <!-- Custom select JS -->
  <script src="{% static 'libs/js/ui-bootstrap-tpls.js' %}"></script> <!-- Competition App -->
  <script src="{% static 'js/competition.js' %}"></script> <!-- Competition App -->
{% endblock %}
