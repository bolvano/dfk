{% extends 'pgups/base.html' %}
{% load staticfiles %}
{% block content %}

<div ng-app="competitionApp" ng-controller="CompetitionController as comp">

  <!-- HEADING -->
  <div class="heading">
    <h1>{{competition.name|capfirst}}</h2>
  </div>

  {% if not competition.finished %}

    <div class="row dfk-tabs-content">

      <div class="col s9">
        <div class="row">
          <div class="col s12">
            <ul class="tabs tabs-fixed-width">
              <li class="tab col s3"><a class="active light-blue-text text-darken-3" href="#requests">Заявки</a></li>
              <li class="tab col s3"><a class="light-blue-text text-darken-3" href="#teams">Команды</a></li>
              {% if user.is_authenticated %}
              <li class="tab col s3"><a class="light-blue-text text-darken-3" href="#tours">Дисциплины</a></li>
              <li class="tab col s3"><a class="light-blue-text text-darken-3" href="#relays">Эстафеты</a></li>
              {% endif %}
            </ul>
          </div>
        </div>

        <div class="tab-content">

          <!-- REQUESTS -->
          <div id="requests">
            <table class="table bordered centered highlight">
              <thead>
                <tr>
                  <th>Дата</th>
                  <th>Команда</th>
                  <th>Тренер</th>
                  {% if user.is_authenticated %}
                    <th>Подтверждено</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for userrequest in competition.userrequest_set.all %}
                  <tr >
                    <td>
                      <a href="../../userrequest/{{userrequest.id}}/">{{userrequest.date|date:"d.m.Y"}}</a>
                    </td>
                    {% if userrequest.team %} <td>{{userrequest.team}}</td>
                    {% else %} <td>индивидуальная заявка</td> {% endif %}
                    <td>{{userrequest.representative}}</td>
                    {% if user.is_authenticated %}
                    <td>{{userrequest.approved_competitors|length}} из {{userrequest.competitor_set.all|length}}</td>
                    {% endif %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- TEAMS -->
          <div id="teams">
            <ul class="collection">
              {% for team in teams %}
              <a class="collection-item" href="../../competition/team/{{competition.id}}/{{team.id}}/">{{team}}</a>
              {% endfor %}
              <a class="collection-item" href="../../competition/team/{{competition.id}}/0/">Без команды</a>
            </ul>
          </div>

          <!-- TOURS -->
          {% if user.is_authenticated %}
          <div id="tours" class="tab-pane fade">
            <ul class="collection">
              {% for tour in competition.tour_set.all %}
              <a class="collection-item" href="../../tour/{{tour.id}}/">{{tour}}</a>
              {% endfor %}
            </ul>
          </div>

          <!-- RELAYS -->
          <div id="relays">
            <ul class="collection">
              {% for relay in relays %}
              <a class="collection-item" href="../../relay_teams/{{relay.id}}/">{{relay}}</a>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
        </div>
      </div>

    {% if user.is_authenticated %}
      <div class="col s3">

        <ul>
          <li>
            <a class="btn-flat dfk-side-btn" href="../../competition/starts/{{competition.id}}/">
               <span>Сетка заплывов</span>
               <i class="material-icons right">view_list</i>
            </a>
          </li>

          <li>
            <a class="btn-flat dfk-side-btn" href="{% url 'starts_print' competition_id=competition.id %}" target="_blank">
              <span>Стартовые протоколы</span>
              <i class="material-icons right">print</i>
            </a>
          </li>

          <li>
            <a class="btn-flat dfk-side-btn" href="#" ng-click="comp.openModal()">
              <span>Перегенерировать заплывы</span>
              <i class="material-icons right">refresh</i>
            </a>
          </li>

          <li class="bordered-item">
            <a class="btn-flat dfk-side-btn" href="../../competition_starts_sort/{{competition.id}}/">
              <span>Настройка заплывов</span>
              <i class="material-icons right">build</i>
            </a>
          </li>

          <li>
            <a class="btn-flat dfk-side-btn" href="../../competition/relay_starts/{{competition.id}}/">
              <span>Сетка эстафет</span>
              <i class="material-icons right">view_list</i>
            </a>
          </li>

          <li>
            <a class="btn-flat dfk-side-btn" href="../../competition_relays_sort/{{competition.id}}/">
              <span>Настройка эстафет</span>
              <i class="material-icons right">build</i>
            </a>
          </li>

          <li class="bordered-item">
            <a class="btn-flat dfk-side-btn" href="#" ng-click="comp.openModalRelay();">
              <span>Перегенерировать эстафеты</span>
              <i class="material-icons right">refresh</i>
            </a>
          </li>

          <li>
            <a class="btn-flat dfk-side-btn" href="{% url 'competitionedit' competition_id=competition.id %}/" target="_blank">
              <span>Редактировать соревнования</span><i class="material-icons right">settings</i>
            </a>
          </li>

          <li>
            <form action="." method="POST" >{% csrf_token %}
              <input type="hidden" name="competition_id" value="{{competition.id}}">
              <input type="hidden" name="close" value="1">
              <button type="submit" class="btn-flat dfk-btn-link dfk-side-btn">
                <span>Закрыть соревнования</span>
                <i class="material-icons right">power_settings_new</i>
              </button>
            </form>
          </li>

        </ul>

      </div>

    </div>

    <!-- MODAL TEMPLATE -->
    <script type="text/ng-template" id="modal.html">
      <div class="modal-content">

        <div class="modal-header text-center">
          <i><span class="text-danger">Внимание!</span> Текущие результаты заплывов будут удалены и сетка будет сгенерирована заново.</i>
        </div>

        <div class="modal-body">
          <form action="../../generate_starts/" method="POST" class="inline-form" ng-submit="$ctrl.cancel()">{% csrf_token %}
              <input type="hidden" name="competition_id" value="{{competition.id}}">

              <div class="row fields">
                <div class="col-sm-6">
                  <select name="lanes" class="lanes-select">
                    <option value="5">5 дорожек</option>
                    <option value="6">6 дорожек</option>
                  </select>
                </div>
                <div class="col-sm-6">
                  <input type="checkbox" name="ages" id="ages">
                    <label for="ages">С разбивкой по возрастам</label>
                </div>
              </div>

              <div class="modal-footer">
                <div class="btns-wrapper">
                  <button type="submit" class="btn btn-default">Перегенерировать</button>
                  <button type="button" ng-click="$ctrl.cancel()" class="btn btn-default">Отмена</button>
                </div>
              </div>
          </form>
        </div>

      </div>
    </script>

    <!-- RELAY MODAL TEMPLATE -->
    <script type="text/ng-template" id="modalRelay.html">
      <div class="modal-content">

        <div class="modal-header text-center">
          <i><span class="text-danger">Внимание!</span> Текущие результаты эстафет будут удалены и сетка будет
              сгенерирована заново.</i>
        </div>

        <div class="modal-body">
          <form action="../../generate_relay_starts/" method="POST" class="inline-form" ng-submit="$ctrl.cancel()">{% csrf_token %}
              <input type="hidden" name="competition_id" value="{{competition.id}}">

              <div class="row fields">
                <div class="col-sm-6">
                  <select name="lanes" class="lanes-select">
                    <option value="5">5 дорожек</option>
                    <option value="6">6 дорожек</option>
                  </select>
                </div>
                <!-- <div class="col-sm-6">
                  <input type="checkbox" name="ages" id="ages">
                    <label for="ages">С разбивкой по возрастам</label>
                </div> -->
              </div>

              <div class="modal-footer">
                <div class="btns-wrapper">
                  <button type="submit" class="btn btn-default">Перегенерировать</button>
                  <button type="button" ng-click="$ctrl.cancel()" class="btn btn-default">Отмена</button>
                </div>
              </div>
          </form>
        </div>

      </div>
    </script>

    {% endif %}

  {% else %}

  <div class="competition-menu">

    <p>
      <a class="btn btn-lg btn-primary" href="../../results/starts/{{competition.id}}/"><span class="glyphicon glyphicon-list-alt"></span> Результаты по заплывам и дорожкам</a>
    </p>

    <p>
      <a class="btn btn-lg btn-primary" href="../../results/tours/{{competition.id}}/"><span class="glyphicon glyphicon-list-alt"></span> Результаты по дисциплинам</a>
    </p>

    <p>
      <a class="btn btn-lg btn-primary" href="../../results/teams/{{competition.id}}/"><span class="glyphicon glyphicon-list-alt"></span> Результаты по командам</a>
    </p>

    <p>
      <a class="btn btn-lg btn-primary" href="{% url 'final_print' competition_id=competition.id %}" target="_blank"> <span class="glyphicon glyphicon-print"></span> Итоговые протоколы</a>
    </p>

    {% if user.is_authenticated %}
        <form action="." method="POST" >{% csrf_token %}
          <input type="hidden" name="competition_id" value="{{competition.id}}">
          <input type="hidden" name="close" value="0">
          <button type="submit" class="close-competition btn btn-lg btn-default">
            <span class="glyphicon glyphicon-wrench"></span> Редактировать результаты соревнований
          </button>
        </form>
    {% endif %}

  </div>

  {% endif %}

</div>

{% endblock %}

{% block additionaljs %}
  <link href="{% static 'libs/css/bootstrap-select.min.css' %}" rel="stylesheet"> <!-- Custom select styles -->
  <script src="{% static 'libs/js/bootstrap-select.min.js' %}"></script> <!-- Custom select JS -->
  <script src="{% static 'libs/js/ui-bootstrap-tpls.js' %}"></script> <!-- Competition App -->
  <script src="{% static 'js/competition.js' %}"></script> <!-- Competition App -->
{% endblock %}
